name: Velopack リリース作成

on:
  push:

permissions:
  contents: write

jobs:
  build-release:
    name: リリースビルド (${{ matrix.name }})
    if: ${{ startsWith(github.ref, 'refs/heads/release/') }}
    strategy:
      matrix:
        include:
          - name: Windows
            os: windows-latest
            rid: win-x64
            channel: win
          - name: macOS (ARM)
            os: macos-latest
            rid: osx-arm64
            channel: osx-arm64
          - name: macOS (Intel)
            os: macos-13
            rid: osx-x64
            channel: osx-x64
    runs-on: ${{ matrix.os }}
    steps:
      - name: リポジトリをチェックアウト
        uses: actions/checkout@v4

      - name: .NET SDK をセットアップ
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: 依存関係を復元
        run: dotnet restore UltraMDmemo.slnx

      - name: リリースバージョンを設定
        shell: bash
        run: |
          VERSION=$(sed -n 's/.*<Version>\([^<]*\)<\/Version>.*/\1/p' Directory.Build.props)
          if [ -z "$VERSION" ]; then
            echo "Version not found in Directory.Build.props"
            exit 1
          fi
          echo "RELEASE_VERSION=$VERSION" >> $GITHUB_ENV
          echo "Version found: $VERSION"

      - name: アプリを公開ビルド
        shell: bash
        run: |
          dotnet publish "UltraMDmemo.csproj" \
            -c Release \
            -r ${{ matrix.rid }} \
            -o publish

          echo "Publish directory contents:"
          ls -la publish/ | head -20

      - name: Velopack CLI をインストール
        run: dotnet tool install --global vpk

      - name: Velopack パッケージを作成 (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          vpk pack `
            --packId UltraMDmemo `
            --packVersion $env:RELEASE_VERSION `
            --packTitle "UltraMDmemo" `
            --packAuthors "szk-oss" `
            --mainExe UltraMDmemo.exe `
            --packDir publish `
            --outputDir artifacts `
            --channel ${{ matrix.channel }} `
            --shortcuts "StartMenu,Desktop"

      - name: Velopack パッケージを作成 (macOS)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          vpk pack \
            --packId UltraMDmemo \
            --packVersion $RELEASE_VERSION \
            --packTitle "UltraMDmemo" \
            --packAuthors "szk-oss" \
            --mainExe UltraMDmemo \
            --packDir publish \
            --outputDir artifacts \
            --channel ${{ matrix.channel }} \
            --icon icon/app.icns

      - name: 既存リリースを削除
        shell: bash
        run: |
          gh release delete "$RELEASE_VERSION" --repo "${{ github.repository }}" --yes 2>/dev/null || echo "No existing release to delete"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: GitHub Releases にアップロード
        shell: bash
        run: |
          REPO_URL="https://github.com/${{ github.repository }}"
          RELEASE_NAME="UltraMDmemo $RELEASE_VERSION"

          vpk upload github \
            --repoUrl "$REPO_URL" \
            --token "${{ secrets.GITHUB_TOKEN }}" \
            --outputDir artifacts \
            --channel ${{ matrix.channel }} \
            --publish \
            --releaseName "$RELEASE_NAME"
