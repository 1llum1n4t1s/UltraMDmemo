<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:UltraMDmemo.ViewModels"
        xmlns:md="clr-namespace:Markdown.Avalonia;assembly=Markdown.Avalonia"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="800"
        x:Class="UltraMDmemo.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Icon="/Assets/avalonia-logo.ico"
        Title="UltraMDmemo"
        WindowStartupLocation="CenterScreen"
        Width="1200" Height="800"
        MinWidth="800" MinHeight="600">

    <Grid>
        <!-- ===== LOADING SCREEN (起動シーケンス中に表示) ===== -->
        <Border IsVisible="{Binding IsInitializing}"
                Background="{DynamicResource Container2BackgroundBrush}"
                ZIndex="100">
            <StackPanel VerticalAlignment="Center" HorizontalAlignment="Center" Spacing="20">
                <TextBlock Text="UltraMDmemo" FontSize="32" FontWeight="Bold"
                           HorizontalAlignment="Center"/>
                <ProgressBar IsIndeterminate="True" Width="300" Height="4"/>
                <TextBlock Text="{Binding InitializationStep}" FontSize="14"
                           HorizontalAlignment="Center" Opacity="0.8"/>
            </StackPanel>
        </Border>

        <!-- ===== MAIN CONTENT (初期化完了後に表示) ===== -->
        <DockPanel IsVisible="{Binding IsMainVisible}">
            <!-- ===== HEADER ===== -->
            <Border DockPanel.Dock="Top" Padding="12,6"
                    BorderBrush="{DynamicResource Container3BorderBrush}"
                    BorderThickness="0,0,0,1">
                <Grid RowDefinitions="Auto,Auto" ColumnDefinitions="*,Auto">
                    <!-- Row 0, Col 0: Title -->
                    <TextBlock Grid.Row="0" Grid.Column="0"
                               Text="UltraMDmemo" FontSize="20" FontWeight="Bold"
                               VerticalAlignment="Center"/>
                    <!-- Row 0, Col 1: Action Buttons -->
                    <StackPanel Grid.Row="0" Grid.Column="1"
                                Orientation="Horizontal" Spacing="8">
                        <Button Content="整形する" Command="{Binding TransformCommand}"
                                Classes="theme-accent" Padding="24,6" FontWeight="Bold"/>
                        <Button Content="クリア" Command="{Binding ClearCommand}" Padding="20,6"/>
                    </StackPanel>

                    <!-- Row 1: Options (colspan=2 で全幅使用) -->
                    <Grid Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2"
                          ColumnDefinitions="Auto,Auto,Auto,*" Margin="0,6,0,0">
                        <!-- Col 0: 種類 -->
                        <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="6" Margin="0,0,16,0">
                            <TextBlock Text="種類:" VerticalAlignment="Center"/>
                            <ComboBox ItemsSource="{Binding IntentOptions}"
                                      SelectedItem="{Binding SelectedIntentItem}"
                                      MinWidth="140"/>
                        </StackPanel>
                        <!-- Col 1: モード -->
                        <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="6" Margin="0,0,16,0">
                            <TextBlock Text="モード:" VerticalAlignment="Center"/>
                            <ComboBox ItemsSource="{Binding ModeOptions}"
                                      SelectedItem="{Binding SelectedModeItem}"
                                      MinWidth="100"/>
                        </StackPanel>
                        <!-- Col 2: 末尾に原文挿入 -->
                        <CheckBox Grid.Column="2" Content="末尾に原文挿入"
                                  IsChecked="{Binding IncludeRaw}"
                                  VerticalAlignment="Center" Margin="0,0,16,0"/>
                        <!-- Col 3: タイトル指示 (残り幅を使用) -->
                        <DockPanel Grid.Column="3">
                            <TextBlock DockPanel.Dock="Left" Text="タイトル指示:" VerticalAlignment="Center"
                                       Margin="0,0,6,0"/>
                            <TextBox Text="{Binding TitleHint}" VerticalAlignment="Center"/>
                        </DockPanel>
                    </Grid>
                </Grid>
            </Border>

            <!-- ===== CLI Warning ===== -->
            <Border DockPanel.Dock="Top" Padding="8" Background="#E65100"
                    IsVisible="{Binding !IsCliAvailable}">
                <TextBlock Text="Claude Code CLI との接続が確認できません。アプリを再起動して再試行してください。"
                           Foreground="White" FontWeight="Bold"/>
            </Border>

            <!-- ===== Progress Bar ===== -->
            <ProgressBar DockPanel.Dock="Top" IsIndeterminate="True"
                         IsVisible="{Binding IsProcessing}" Height="3" Margin="0"/>

            <!-- ===== FOOTER ===== -->
            <Border DockPanel.Dock="Bottom" Padding="8,4"
                    BorderBrush="{DynamicResource Container3BorderBrush}"
                    BorderThickness="0,1,0,0">
                <Grid ColumnDefinitions="*,Auto">
                    <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="16">
                        <TextBlock Text="{Binding StatusMessage}" VerticalAlignment="Center"
                                   MaxWidth="500" TextTrimming="CharacterEllipsis"/>
                        <TextBlock VerticalAlignment="Center" Opacity="0.7">
                            <TextBlock.Text>
                                <MultiBinding StringFormat="文字数: {0} / 20,000">
                                    <Binding Path="InputLength"/>
                                </MultiBinding>
                            </TextBlock.Text>
                        </TextBlock>
                        <TextBlock Text="{Binding ErrorMessage}" Foreground="#D32F2F"
                                   VerticalAlignment="Center"
                                   IsVisible="{Binding ErrorMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                                   MaxWidth="400" TextTrimming="CharacterEllipsis"/>
                    </StackPanel>

                    <Button Grid.Column="1" Content="履歴" Command="{Binding ToggleHistoryCommand}"
                            Padding="12,4"/>
                </Grid>
            </Border>

            <!-- ===== MAIN CONTENT with History SplitView ===== -->
            <SplitView IsPaneOpen="{Binding IsHistoryPanelVisible}"
                       DisplayMode="Inline"
                       PanePlacement="Right"
                       OpenPaneLength="320">

                <!-- History Pane -->
                <SplitView.Pane>
                    <Border BorderBrush="{DynamicResource Container3BorderBrush}"
                            BorderThickness="1,0,0,0">
                        <DockPanel>
                            <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Spacing="8"
                                        Margin="8" VerticalAlignment="Center">
                                <TextBlock Text="履歴" FontWeight="Bold" FontSize="16"
                                           VerticalAlignment="Center"/>
                                <Button Content="更新" Command="{Binding ReloadHistoryCommand}"
                                        Padding="8,2"/>
                            </StackPanel>
                            <ListBox ItemsSource="{Binding HistoryItems}"
                                     SelectedItem="{Binding SelectedHistoryItem}"
                                     Margin="4,0,4,4">
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <StackPanel Spacing="2" Margin="4">
                                            <TextBlock Text="{Binding Title}" FontWeight="SemiBold"
                                                       TextTrimming="CharacterEllipsis"/>
                                            <TextBlock Text="{Binding CreatedAt, StringFormat='{}{0:yyyy-MM-dd HH:mm}'}"
                                                       FontSize="11" Opacity="0.6"/>
                                            <StackPanel Orientation="Horizontal" Spacing="4" Margin="0,4,0,0">
                                                <Button Content="読込" Padding="6,2" FontSize="11"
                                                        Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).LoadHistoryItemCommand}"
                                                        CommandParameter="{Binding}"/>
                                                <Button Content="再整形" Padding="6,2" FontSize="11"
                                                        Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).RerunHistoryItemCommand}"
                                                        CommandParameter="{Binding}"/>
                                                <Button Content="削除" Padding="6,2" FontSize="11" Foreground="#D32F2F"
                                                        Command="{Binding $parent[Window].((vm:MainWindowViewModel)DataContext).DeleteHistoryItemCommand}"
                                                        CommandParameter="{Binding}"/>
                                            </StackPanel>
                                        </StackPanel>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                        </DockPanel>
                    </Border>
                </SplitView.Pane>

                <!-- Main Content -->
                <SplitView.Content>
                    <Grid ColumnDefinitions="*,4,*" Margin="8">
                        <!-- Left: Input -->
                        <TextBox Grid.Column="0"
                                 Text="{Binding InputText}"
                                 AcceptsReturn="True" AcceptsTab="True"
                                 TextWrapping="Wrap"
                                 Watermark="整形したいテキストをここに入力..."
                                 FontFamily="Consolas, Yu Gothic UI, monospace"/>

                        <GridSplitter Grid.Column="1" Background="{DynamicResource Container3BorderBrush}"
                                      ResizeDirection="Columns"/>

                        <!-- Right: Output -->
                        <DockPanel Grid.Column="2">
                            <!-- Output action buttons -->
                            <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Spacing="8"
                                        Margin="0,0,0,8">
                                <Button Content="コピー" Command="{Binding RequestCopyCommand}"
                                        IsEnabled="{Binding HasOutput}" Padding="8,4"/>
                                <Button Content="保存 (.md)" Command="{Binding RequestSaveMarkdownCommand}"
                                        IsEnabled="{Binding HasOutput}" Padding="8,4"/>
                                <Button Content="Meta保存 (.json)" Command="{Binding RequestSaveMetaCommand}"
                                        IsEnabled="{Binding HasOutput}" Padding="8,4"/>
                            </StackPanel>

                            <!-- Preview / Raw Tabs -->
                            <TabControl SelectedIndex="{Binding SelectedOutputTab}">
                                <TabItem Header="Preview">
                                    <md:MarkdownScrollViewer Markdown="{Binding OutputMarkdown}"
                                                             Margin="4"/>
                                </TabItem>
                                <TabItem Header="Raw">
                                    <TextBox Text="{Binding OutputMarkdown, Mode=OneWay}"
                                             IsReadOnly="True"
                                             AcceptsReturn="True"
                                             TextWrapping="Wrap"
                                             FontFamily="Consolas, Yu Gothic UI, monospace"/>
                                </TabItem>
                            </TabControl>
                        </DockPanel>
                    </Grid>
                </SplitView.Content>
            </SplitView>
        </DockPanel>
    </Grid>
</Window>
